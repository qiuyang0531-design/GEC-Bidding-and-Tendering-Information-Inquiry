# 更新日志

## v1.4.1 (2026-01-26)

### 🐛 Bug修复

#### 修复交易数据无法显示的问题
- **问题**：数据库迁移后，API查询仍使用旧的`transaction_date`字段，导致查询失败
- **错误信息**：`column transactions.transaction_date does not exist`
- **修复方案**：
  - 更新`getTransactions`函数，使用新的三个日期字段
  - 日期筛选：支持`award_date`（中标日期）和`bid_start_date`（招标开始日期）
  - 排序逻辑：优先按`award_date`降序，其次按`bid_start_date`降序
  - NULL值处理：使用`nullsFirst: false`确保有日期的记录优先显示

#### 技术细节
```typescript
// 修复前（错误）
query = query.gte('transaction_date', startDate);
query = query.lte('transaction_date', endDate);
query.order('transaction_date', { ascending: false });

// 修复后（正确）
query = query.or('award_date.gte.${startDate},bid_start_date.gte.${startDate}');
query.order('award_date', { ascending: false, nullsFirst: false })
     .order('bid_start_date', { ascending: false, nullsFirst: false });
```

### ✅ 验证结果
- 数据库包含4条示例数据（3条已中标，1条招标中）
- API查询成功返回所有数据
- 交易数据表格正常显示
- 代码质量检查通过

---

## v1.4.0 (2026-01-26)

### 🎯 新增功能

#### 日期字段拆分为三个独立字段
- ✅ **招标开始日期**（bid_start_date）：招标公告发布或开始接受投标的日期
- ✅ **招标结束日期**（bid_end_date）：招标截止日期
- ✅ **中标日期**（award_date）：公布中标结果的日期
- ✅ 更准确地区分招标信息和中标信息

### 📊 数据更新

#### 示例数据调整
- 为所有项目添加完整的日期信息
- 展示招标中和已中标两种状态

#### 当前示例数据分布
| 项目 | 招标开始 | 招标结束 | 中标日期 | 状态 |
|------|---------|---------|---------|------|
| 2025年度风电绿色电力证书交易项目 | 2025-11-01 | 2025-11-15 | 2025-11-20 | ✅ 已中标 |
| 光伏绿证采购项目（第一批） | 2024-12-10 | 2024-12-25 | 2025-01-05 | ✅ 已中标 |
| 分布式光伏绿证交易项目 | 2025-12-01 | 2025-12-10 | 2025-12-15 | ✅ 已中标 |
| 集中式风电绿证交易（第二批） | 2025-12-15 | 2025-12-30 | - | ⏳ 招标中 |

### 🔧 技术改进

#### 数据库迁移
- 创建迁移：split_transaction_date_to_three_dates
- 删除transaction_date字段
- 添加bid_start_date、bid_end_date、award_date三个字段
- 将现有数据迁移到award_date字段
- 添加字段注释说明

#### 类型定义更新
- 更新Transaction接口：删除transaction_date
- 添加bid_start_date、bid_end_date、award_date三个字段
- 所有日期字段都是可选的string类型

#### UI组件优化
- TransactionTable组件：将"交易日期"列改为三列
- 表头更新：招标开始日期、招标结束日期、中标日期
- 使用formatDate函数格式化显示

#### Edge Function优化
- 更新字段说明注释（10个字段 → 12个字段）
- 添加三个日期字段的提取示例
- 更新console.log输出信息

### 📚 文档更新

#### 更新文档
- ✅ **SCRAPING_GUIDE.md**
  - 更新数据字段表（transaction_date → 三个日期字段）
  - 添加日期处理函数说明
  - 添加三个日期字段的使用场景说明
  - 更新示例代码中的日期字段提取

- ✅ **QUICKSTART.md**
  - 更新所有示例数据，添加三个日期字段
  - 添加日期字段的详细说明
  - 展示招标中和已中标两种状态

- ✅ **TODO.md**
  - 更新数据字段说明（10个 → 12个）
  - 添加日期字段的完成情况
  - 更新重要说明部分

- ✅ **CHANGELOG.md**
  - 记录v1.4.0版本更新内容

### ✅ 验证结果

#### 数据库验证
```sql
SELECT 
  project_name,
  bid_start_date,
  bid_end_date,
  award_date,
  CASE 
    WHEN award_date IS NOT NULL THEN '已中标'
    ELSE '招标中'
  END as 状态
FROM transactions;
```

**结果**：
- 已中标：3条
- 招标中：1条
- 总计：4条

#### 代码质量验证
```bash
npm run lint
```
**结果**：✅ 通过（80个文件，无错误）

### 🎨 UI效果

#### 日期显示
- **招标开始日期**：格式化显示（如"2025/11/1"）
- **招标结束日期**：格式化显示（如"2025/11/15"）
- **中标日期**：格式化显示或"-"（招标中）

#### 表格布局
- 原来10列 → 现在12列
- 日期列宽度自适应
- 保持良好的可读性

### 📝 使用说明

#### 数据抓取时
```typescript
// 提取三个日期字段
const transaction = {
  // ... 其他字段
  bid_start_date: parseDate(extractField(html, 'bid_start')),
  bid_end_date: parseDate(extractField(html, 'bid_end')),
  award_date: parseDate(extractField(html, 'award')),
};
```

#### 数据展示时
- 应用会自动格式化日期显示
- 空值显示为"-"
- 用户可以清楚地看到招标和中标的时间线

### 🔄 兼容性

#### 向后兼容
- 数据库迁移自动处理
- 现有的transaction_date数据迁移到award_date
- UI自动适配新字段

#### 数据迁移
- 自动迁移：transaction_date → award_date
- 新字段：bid_start_date、bid_end_date初始为NULL
- 示例数据已更新完整日期信息

### 🎯 业务价值

#### 更准确的信息表示
- 区分招标信息和中标信息
- 清晰展示招标时间线
- 方便用户了解项目进度

#### 更灵活的数据查询
- 可以按招标开始日期筛选
- 可以按招标结束日期筛选
- 可以按中标日期筛选
- 可以查询招标中的项目（award_date为NULL）

#### 更完整的数据记录
- 如实记录招标和中标的完整时间信息
- 不丢失任何日期信息
- 便于后续分析和统计

### 💡 实际应用场景

#### 场景1：已中标项目
```
项目：2025年度风电绿证交易
招标开始：2025-11-01
招标结束：2025-11-15
中标日期：2025-11-20
说明：完整的招标和中标时间线
```

#### 场景2：招标中项目
```
项目：集中式风电绿证交易（第二批）
招标开始：2025-12-15
招标结束：2025-12-30
中标日期：-
说明：项目正在招标中，尚未公布中标结果
```

#### 场景3：跨年度招标
```
项目：光伏绿证采购项目（第一批）
招标开始：2024-12-10
招标结束：2024-12-25
中标日期：2025-01-05
说明：招标在2024年底，中标在2025年初
```

---

## v1.3.0 (2026-01-26)

### 🎯 新增功能

#### 绿证年份支持多年份格式
- ✅ **单年份**：如"2025"
- ✅ **多年份**：如"2024/2025"或"2024-2026"
- ✅ 数据库字段类型从INTEGER改为TEXT，支持更灵活的年份格式

### 📊 数据更新

#### 示例数据调整
- 更新2条示例数据为多年份格式
- 展示单年份和多年份的实际应用场景

#### 当前示例数据分布
| 项目 | 单价 | 通道类型 | 年份 |
|------|------|---------|------|
| 2025年度风电绿色电力证书交易项目 | 7.20元 | ✅ 通道 | 2025 |
| 光伏绿证采购项目（第一批） | 6.80元 | ➖ 未标注 | 2024/2025 |
| 分布式光伏绿证交易项目 | 7.35元 | ✅ 通道 | 2025 |
| 集中式风电绿证交易（第二批） | 6.58元 | ➖ 未标注 | 2025/2026 |

### 🔧 技术改进

#### 数据库迁移
- 创建迁移：change_cert_year_to_text
- 修改cert_year字段类型：INTEGER → TEXT
- 使用USING子句安全转换现有数据

#### 类型定义更新
- 更新Transaction接口：cert_year从number改为string
- 添加注释说明支持单年份和多年份格式

#### Edge Function优化
- 更新字段说明注释
- 添加年份提取示例代码
- 移除parseInt转换，直接使用文本格式

### 📚 文档更新

#### 更新文档
- ✅ **SCRAPING_GUIDE.md**
  - 更新cert_year字段类型说明（INTEGER → TEXT）
  - 添加extractYear函数示例
  - 支持多种年份格式的解析

- ✅ **QUICKSTART.md**
  - 更新示例数据说明
  - 添加多年份格式的示例
  - 完善重要说明部分

- ✅ **CHANGELOG.md**
  - 记录v1.3.0版本更新内容

### ✅ 验证结果

#### 数据库验证
```sql
SELECT 
  project_name,
  cert_year,
  CASE 
    WHEN cert_year LIKE '%/%' THEN '多年份'
    ELSE '单年份'
  END as 年份类型
FROM transactions;
```

**结果**：
- 单年份：2条
- 多年份：2条
- 总计：4条

#### 代码质量验证
```bash
npm run lint
```
**结果**：✅ 通过（80个文件，无错误）

### 🎨 UI效果

#### 年份显示
- **单年份**：直接显示"2025"
- **多年份**：显示"2024/2025"
- 无需特殊样式，文本显示即可

### 📝 使用说明

#### 数据抓取时
```typescript
// 使用extractYear函数处理年份
cert_year: extractYear(extractedText)

// 函数会返回：
// - "2025": 单年份
// - "2024/2025": 多年份（统一使用"/"分隔）
// - null: 无法提取年份
```

#### 数据展示时
- 应用会直接显示cert_year字段的文本值
- 单年份和多年份使用相同的显示方式
- 用户可以清楚地看到绿证涵盖的年份范围

### 🔄 兼容性

#### 向后兼容
- 数据库迁移使用USING子句安全转换
- 现有的整数年份自动转换为文本格式
- UI显示不受影响（原本就是文本显示）

#### 数据迁移
- 自动迁移：INTEGER值自动转换为TEXT
- 示例：2025 → "2025"
- 无需手动干预

### 🎯 业务价值

#### 更真实的数据表示
- 反映实际业务场景
- 有些绿证交易确实涵盖多个年份
- 如"2024/2025年度绿证"

#### 更灵活的数据存储
- 支持各种年份格式
- 单年份："2025"
- 多年份："2024/2025"
- 年份范围："2024-2026"

#### 更准确的信息记录
- 如实记录原始数据
- 不丢失年份信息
- 便于后续分析和统计

### 💡 实际应用场景

#### 场景1：单年份绿证
```
项目：2025年度风电绿证交易
绿证年份：2025
说明：该批绿证仅涵盖2025年
```

#### 场景2：跨年度绿证
```
项目：2024/2025年度光伏绿证采购
绿证年份：2024/2025
说明：该批绿证涵盖2024和2025两个年度
```

#### 场景3：多年度绿证
```
项目：2025-2026年度风电绿证交易
绿证年份：2025/2026
说明：该批绿证涵盖2025至2026年度
```

---

## v1.2.0 (2026-01-26)

### 🎯 新增功能

#### 通道类型三种状态支持
- ✅ **通道**（is_channel = true）：明确标注为通道交易，显示蓝色徽章
- ✅ **非通道**（is_channel = false）：明确标注为非通道交易，显示灰色徽章
- ✅ **未标注**（is_channel = null）：项目未标注通道类型，显示"-"

### 📊 数据更新

#### 示例数据调整
- 更新2条示例数据的通道类型为NULL（未标注）
- 保持2条示例数据的通道类型为true（通道）
- 展示通道类型的三种实际应用场景

#### 当前示例数据分布
| 项目 | 单价 | 通道类型 |
|------|------|---------|
| 2025年度风电绿色电力证书交易项目 | 7.20元 | ✅ 通道 |
| 光伏绿证采购项目（第一批） | 6.80元 | ➖ 未标注 |
| 分布式光伏绿证交易项目 | 7.35元 | ✅ 通道 |
| 集中式风电绿证交易（第二批） | 6.58元 | ➖ 未标注 |

### 🔧 技术改进

#### Edge Function优化
- 更新parseChannelType函数注释
- 添加通道类型解析辅助函数示例
- 完善字段说明文档

#### 代码优化
- TransactionTable组件已正确处理null值
- UI显示逻辑完善（null显示为"-"）
- 数据库字段支持NULL值

### 📚 文档更新

#### 新增文档
- ✅ **CHANNEL_TYPE_GUIDE.md**（5000+字）
  - 通道类型三种状态的详细说明
  - 数据库设计和UI显示
  - 数据抓取处理方法
  - 实际应用场景和最佳实践

#### 更新文档
- ✅ **SCRAPING_GUIDE.md**
  - 更新parseChannelType函数说明
  - 添加三种状态的处理示例
  - 完善通道类型解析逻辑

- ✅ **QUICKSTART.md**
  - 更新示例数据说明
  - 添加通道类型三种状态的说明
  - 调整示例数据的通道类型显示

- ✅ **DATA_CORRECTION.md**
  - 记录通道类型功能更新
  - 更新示例数据说明
  - 添加三种状态的实现方式

- ✅ **TODO.md**
  - 更新完成情况
  - 添加通道类型说明

- ✅ **README.md**
  - 添加CHANNEL_TYPE_GUIDE.md链接
  - 添加DATA_CORRECTION.md链接

### ✅ 验证结果

#### 数据库验证
```sql
SELECT 
  CASE 
    WHEN is_channel = true THEN '通道'
    WHEN is_channel = false THEN '非通道'
    WHEN is_channel IS NULL THEN '未标注'
  END as 通道类型,
  COUNT(*) as 数量
FROM transactions
GROUP BY is_channel;
```

**结果**：
- 通道：2条
- 未标注：2条
- 总计：4条

#### 代码质量验证
```bash
npm run lint
```
**结果**：✅ 通过（80个文件，无错误）

### 🎨 UI效果

#### 通道类型显示
- **通道**：蓝色徽章，文字"通道"
- **非通道**：灰色徽章，文字"非通道"
- **未标注**：普通文本"-"

#### 用户体验
- 清晰区分三种状态
- 视觉效果一致
- 符合用户预期

### 📝 使用说明

#### 数据抓取时
```typescript
// 使用parseChannelType函数处理通道类型
is_channel: parseChannelType(extractedText)

// 函数会返回：
// - true: 文本包含"通道"且不包含"非"
// - false: 文本包含"非通道"
// - null: 空值、"-"或其他情况
```

#### 数据展示时
- 应用会自动根据is_channel的值显示相应的UI
- null值显示为"-"，不会显示为空白
- 用户可以清楚地看到哪些项目未标注通道类型

### 🔄 兼容性

#### 向后兼容
- 现有数据不受影响
- 已有的true/false值继续正常显示
- 新增的null值支持不影响现有功能

#### 数据迁移
- 无需数据迁移
- 数据库字段本身就支持NULL
- 只是更新了部分示例数据

### 🎯 业务价值

#### 更真实的数据展示
- 反映实际业务场景
- 有些项目确实没有标注通道类型
- 避免强制填充不准确的数据

#### 更好的用户体验
- 用户可以清楚地看到数据的完整性
- "-"明确表示"未标注"，而不是"错误"或"缺失"
- 符合用户对真实数据的预期

#### 更灵活的数据处理
- 支持三种状态，适应不同的数据源
- 数据抓取时可以如实记录
- 数据分析时可以单独统计未标注的情况

---

## v1.1.0 (2026-01-26)

### 🔧 数据修正

#### 价格数据调整
- 绿证单价从125-150元调整为6.58-7.35元
- 符合2025年实际市场价格（约7元/张）
- 总价相应调整

#### 详情链接优化
- 示例数据的详情链接设为NULL
- UI显示"暂无链接"提示
- 添加说明文字

### 📚 文档新增
- ✅ SCRAPING_GUIDE.md（8000+字）
- ✅ DATA_CORRECTION.md
- ✅ DELIVERY.md

---

## v1.0.0 (2026-01-26)

### 🎉 初始版本

#### 核心功能
- ✅ 用户认证系统
- ✅ 网址管理功能
- ✅ 数据查询功能
- ✅ 数据展示功能
- ✅ 数据存储功能

#### 数据字段
- ✅ 10个交易信息字段完整实现
- ✅ 数据库结构完善
- ✅ RLS安全策略

#### 文档
- ✅ README.md
- ✅ QUICKSTART.md
- ✅ USAGE.md
- ✅ CHECKLIST.md
- ✅ TODO.md

---

**最后更新**：2026-01-26
**当前版本**：v1.2.0
