# 中国绿色电力证书交易查询应用 - 使用说明

## 应用概述

本应用用于查询和管理中国绿色电力证书交易信息，支持用户注册登录、添加查询网址、自动抓取交易数据，并提供按日期筛选的查询功能。

## 功能特性

### 1. 用户系统
- **用户注册**：使用用户名和密码注册账号
- **用户登录**：使用注册的用户名和密码登录
- **权限管理**：第一个注册的用户自动成为管理员
- **安全认证**：所有数据操作需要登录后才能进行

### 2. 网址管理
- **添加网址**：输入需要查询的绿证交易网站URL
- **网址列表**：查看已添加的所有查询网址
- **删除网址**：移除不需要的查询网址

### 3. 数据查询与展示
- **自动抓取**：点击"执行查询"按钮，系统自动抓取已添加网址的交易数据
- **日期筛选**：支持选择开始日期和结束日期，筛选特定时间段的交易记录
- **数据展示**：以表格形式展示交易信息，包含以下字段：
  - 项目名称
  - 招标单位
  - 投标单位
  - 中标单位
  - 总价
  - 绿证单价
  - 通道类型（通道/非通道）
  - 绿证年份
  - 交易日期
  - 详情链接（点击可跳转到原始页面）

### 4. 数据存储
- 所有查询到的交易数据自动保存到数据库
- 支持历史数据查询和管理
- 数据按用户隔离，保证数据安全

## 使用流程

### 第一步：注册账号
1. 访问应用首页
2. 点击"注册"按钮
3. 输入用户名和密码（密码需输入两次确认）
4. 点击"注册"完成账号创建
5. **注意**：第一个注册的用户将自动成为管理员

### 第二步：登录系统
1. 在登录页面输入用户名和密码
2. 点击"登录"按钮
3. 登录成功后自动跳转到主页面

### 第三步：添加查询网址
1. 在主页面的"网址管理"区域
2. 输入需要查询的绿证交易网站URL
3. 输入网址名称（便于识别）
4. 点击"添加网址"按钮
5. 添加的网址会显示在下方列表中

### 第3.5步：管理网址
1. **查看网址列表**：
   - 在"已添加的网址"区域查看所有网址
   - 每个网址显示备注名称、URL地址和查询状态
2. **编辑网址**：
   - 点击网址右侧的编辑按钮（蓝色铅笔图标）
   - 在弹出的对话框中修改网址或备注名称
   - 点击"保存"按钮完成修改
3. **删除网址**：
   - 点击网址右侧的删除按钮（红色垃圾桶图标）
   - 确认删除操作

### 第四步：执行数据查询
1. 在"数据查询"区域
2. （可选）选择开始日期和结束日期进行筛选
3. 点击"执行查询"按钮
4. 系统会自动抓取所有已添加网址的交易数据
5. 查询结果会显示在下方的交易数据表格中
6. **查看查询状态**：
   - 在"已添加的网址"列表中查看每个网址的查询状态
   - ✅ 绿色勾选：查询成功
   - ❌ 红色叉号：查询失败（会显示具体错误原因）
   - ⚪ 灰色圆圈：未查询
7. **处理失败的网址**：
   - 查看红色错误提示信息
   - 点击编辑按钮修正网址
   - 保存后重新执行查询

### 第五步：查看交易数据
1. 在"交易数据"表格中查看所有查询结果
2. 表格显示完整的交易信息
3. 点击"详情链接"列的图标可跳转到原始页面
4. 通道类型以徽章形式显示（蓝色=通道，灰色=非通道）

## 数据字段说明

| 字段名称 | 说明 | 数据类型 |
|---------|------|---------|
| 项目名称 | 绿证交易项目的名称 | 文本 |
| 招标单位 | 发起招标的单位名称 | 文本 |
| 投标单位 | 参与投标的单位名称 | 文本 |
| 中标单位 | 最终中标的单位名称 | 文本 |
| 总价 | 交易总金额（元） | 数字 |
| 绿证单价 | 每张绿证的单价（元） | 数字 |
| 通道类型 | 是否为通道交易 | 通道/非通道 |
| 绿证年份 | 绿证对应的年份 | 年份 |
| 交易日期 | 交易发生的日期 | 日期 |
| 详情链接 | 查看详细信息的原始链接 | URL |

## 技术说明

### 数据抓取机制
- 应用使用Edge Function实现网页数据抓取
- 当前提供的是基础框架，需要根据实际目标网站的HTML结构进行定制
- 抓取逻辑位于：`supabase/functions/scrape-data/index.ts`

### 定制数据抓取
如需抓取特定网站的数据，需要：

1. **分析目标网站HTML结构**
   - 使用浏览器开发者工具查看页面结构
   - 确定交易数据所在的HTML元素
   - 记录数据的选择器或正则表达式模式

2. **编写解析逻辑**
   - 修改`parseHtmlData`函数
   - 使用正则表达式或HTML解析库提取数据
   - 确保提取所有必需字段

3. **测试验证**
   - 添加测试网址
   - 执行查询验证数据是否正确提取
   - 检查数据库中保存的数据是否完整

### 示例解析代码结构
```typescript
function parseHtmlData(html: string, urlId: string, userId: string): any[] {
  const transactions: any[] = [];
  
  // 1. 使用正则表达式或解析器提取表格行
  const tableRowRegex = /<tr[^>]*>(.*?)<\/tr>/gis;
  const matches = html.matchAll(tableRowRegex);
  
  // 2. 遍历每一行提取数据
  for (const match of matches) {
    const rowHtml = match[1];
    
    // 3. 提取各个字段
    const transaction = {
      url_id: urlId,
      user_id: userId,
      project_name: extractField(rowHtml, 'project'),
      bidding_unit: extractField(rowHtml, 'bidding'),
      bidder_unit: extractField(rowHtml, 'bidder'),
      winning_unit: extractField(rowHtml, 'winning'),
      total_price: parseFloat(extractField(rowHtml, 'price')),
      unit_price: parseFloat(extractField(rowHtml, 'unit_price')),
      detail_link: extractField(rowHtml, 'link'),
      is_channel: extractField(rowHtml, 'channel') === '通道',
      cert_year: parseInt(extractField(rowHtml, 'year')),
      transaction_date: extractField(rowHtml, 'date'),
    };
    
    transactions.push(transaction);
  }
  
  return transactions;
}
```

## 注意事项

1. **首次使用**：第一个注册的用户将自动成为管理员，拥有所有权限
2. **数据安全**：每个用户只能查看和管理自己的数据
3. **网址格式**：添加网址时请确保URL格式正确（包含http://或https://）
4. **数据抓取**：需要根据实际目标网站定制解析逻辑才能正常抓取数据
5. **日期筛选**：不选择日期时默认显示所有交易记录
6. **数据保存**：所有查询到的数据会自动保存，无需手动操作

## 常见问题

**Q: 为什么点击"执行查询"后没有数据？**
A: 可能原因：
- 目标网站没有当日交易数据
- 数据抓取逻辑尚未定制（需要根据实际网站HTML结构编写解析代码）
- 网址不可访问或格式错误
- **查看具体错误**：在"已添加的网址"列表中查看红色错误提示

**Q: 如何查看历史交易数据？**
A: 在"数据查询"区域选择日期范围，系统会显示该时间段内的所有交易记录。

**Q: 可以同时查询多个网址吗？**
A: 可以。添加多个网址后，点击"执行查询"会依次抓取所有网址的数据。

**Q: 如何修改已添加的网址？**
A: 在"已添加的网址"列表中：
1. 找到需要修改的网址
2. 点击右侧的编辑按钮（蓝色铅笔图标）
3. 在弹出的对话框中修改网址或备注名称
4. 点击"保存"按钮完成修改

**Q: 如何知道哪个网址查询失败了？**
A: 在"已添加的网址"列表中，失败的网址会显示：
- 红色背景和边框
- ❌ 红色叉号图标
- 具体的错误信息（如"连接超时"、"404未找到"等）

**Q: 数据会保存多久？**
A: 所有数据永久保存在数据库中，除非手动删除。

**Q: 如何定制数据抓取逻辑？**
A: 需要修改`supabase/functions/scrape-data/index.ts`文件中的`parseHtmlData`函数，根据目标网站的HTML结构编写相应的解析代码。

## 技术支持

如需技术支持或有任何问题，请参考：
- 项目文档：`TODO.md`
- 数据库结构：`supabase/migrations/`目录
- API接口：`src/db/api.ts`
- 类型定义：`src/types/types.ts`

## 版权信息

© 2026 中国绿色电力证书交易查询应用
