# 网址查询状态显示功能说明

## 功能概述

在"已添加的网址"列表中显示每个网址的查询状态，帮助用户快速识别哪些网址查询成功，哪些失败，以及失败的具体原因。

## 功能特性

### 1. 状态图标

每个网址左侧显示状态图标，直观反映查询结果：

| 图标 | 状态 | 说明 |
|------|------|------|
| ✅ 绿色勾选 | 查询成功 | 该网址的数据已成功抓取 |
| ❌ 红色叉号 | 查询失败 | 该网址查询失败，需要检查 |
| ⚪ 灰色圆圈 | 未查询 | 该网址尚未执行查询 |

### 2. 视觉反馈

根据查询状态，网址卡片会显示不同的背景色和边框：

- **查询成功**：绿色背景 + 绿色边框
- **查询失败**：红色背景 + 红色边框
- **未查询**：灰色背景

### 3. 错误信息显示

查询失败的网址会在下方显示具体的错误信息：

```
❌ 上海交易中心
   https://example.com
   ⚠️ 网络请求失败: 连接超时
```

### 4. Tooltip提示

鼠标悬停在状态图标上，会显示详细的状态信息：

- **成功**："查询成功"
- **失败**："查询失败: [具体错误原因]"
- **未查询**："未查询"

## 使用场景

### 场景1：所有网址查询成功

```
已添加的网址

✅ 北京交易中心
   https://beijing.example.com

✅ 上海交易中心
   https://shanghai.example.com

✅ 广州交易中心
   https://guangzhou.example.com
```

**说明**：所有网址都显示绿色勾选图标，表示查询成功。

---

### 场景2：部分网址查询失败

```
已添加的网址

✅ 北京交易中心
   https://beijing.example.com

❌ 上海交易中心
   https://shanghai.example.com
   ⚠️ 网络请求失败: 连接超时

✅ 广州交易中心
   https://guangzhou.example.com
```

**说明**：
- 北京和广州的网址查询成功（绿色）
- 上海的网址查询失败（红色），显示错误原因"连接超时"

---

### 场景3：未执行查询

```
已添加的网址

⚪ 北京交易中心
   https://beijing.example.com

⚪ 上海交易中心
   https://shanghai.example.com
```

**说明**：所有网址都显示灰色圆圈，表示尚未执行查询。

## 常见错误类型

### 1. 网络错误

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| 连接超时 | 网络不稳定或目标服务器响应慢 | 检查网络连接，稍后重试 |
| DNS解析失败 | 域名无法解析 | 检查网址是否正确 |
| 网络不可达 | 无法连接到目标服务器 | 检查网址是否可访问 |

### 2. HTTP错误

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| 404 页面不存在 | 网址路径错误 | 检查网址是否正确 |
| 403 访问被拒绝 | 没有访问权限 | 检查是否需要登录或授权 |
| 500 服务器错误 | 目标服务器内部错误 | 稍后重试或联系网站管理员 |

### 3. 数据错误

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| 页面结构不匹配 | 网站HTML结构已变化 | 需要更新数据抓取逻辑 |
| 数据格式错误 | 数据格式不符合预期 | 检查网站数据格式 |
| 缺少必需字段 | 页面缺少必要的数据字段 | 检查网站是否有完整数据 |

## 操作流程

### 1. 添加网址

1. 在"网址管理"区域输入网址
2. 点击"添加网址"
3. 网址出现在"已添加的网址"列表中
4. 此时状态为"未查询"（灰色圆圈）

### 2. 执行查询

1. 点击"执行查询"按钮
2. 系统开始抓取所有网址的数据
3. 查询过程中，状态会实时更新

### 3. 查看结果

1. 查询完成后，查看每个网址的状态图标
2. 绿色勾选：查询成功
3. 红色叉号：查询失败

### 4. 处理失败的网址

1. 找到显示红色叉号的网址
2. 查看下方的错误信息
3. 根据错误信息进行处理：
   - 网址错误：修改网址
   - 网络问题：检查网络连接
   - 服务器问题：稍后重试
4. 修正后重新执行查询

## 技术实现

### 状态数据结构

```typescript
{
  [urlId: string]: {
    status: 'success' | 'error' | 'idle';
    message?: string;
  }
}
```

### 状态管理

```typescript
// HomePage.tsx
const [urlStatuses, setUrlStatuses] = useState<
  Record<string, { status: 'success' | 'error' | 'idle'; message?: string }>
>({});
```

### 错误捕获

```typescript
try {
  await scrapeUrlData(url.id, url.url);
  newStatuses[url.id] = { status: 'success', message: '查询成功' };
} catch (err: any) {
  let errorMessage = '查询失败';
  if (err.message) {
    errorMessage = err.message;
  } else if (err.context) {
    errorMessage = `${err.context}: ${err.name || '未知错误'}`;
  }
  newStatuses[url.id] = { status: 'error', message: errorMessage };
}
```

### 状态显示

```tsx
{status?.status === 'success' && (
  <CheckCircle2 className="h-5 w-5 text-primary" />
)}
{status?.status === 'error' && (
  <XCircle className="h-5 w-5 text-destructive" />
)}
{!status && (
  <AlertCircle className="h-5 w-5 text-muted-foreground" />
)}
```

## 用户体验优势

### 问题定位

**原来**：
- 只知道"1个网址查询失败"
- 不知道是哪个网址
- 需要逐个测试

**现在**：
- 一眼看出哪个网址失败
- 看到具体错误原因
- 可以针对性修复

### 错误诊断

**原来**：
- 只显示"查询失败"
- 不知道失败原因
- 难以解决问题

**现在**：
- 显示具体错误信息
- 了解失败原因
- 快速解决问题

### 操作效率

**原来**：
- 需要逐个测试网址
- 浪费时间
- 效率低下

**现在**：
- 直接看到失败的网址
- 针对性修复
- 效率提升

## 最佳实践

### 1. 定期检查状态

- 每次查询后检查网址状态
- 及时处理失败的网址
- 保持网址列表的健康状态

### 2. 记录错误信息

- 记录常见的错误类型
- 总结解决方法
- 提高问题解决效率

### 3. 优化网址列表

- 删除长期失败的网址
- 更新已变更的网址
- 保持网址列表的准确性

### 4. 合理重试

- 网络问题：立即重试
- 服务器问题：稍后重试
- 网址错误：修正后重试

## 注意事项

### 1. 状态重置

- 每次点击"执行查询"时，所有状态会重置
- 确保显示的是最新的查询结果

### 2. 错误信息

- 错误信息来自Edge Function的返回
- 不同错误类型有不同的错误信息
- 根据错误信息判断问题原因

### 3. 视觉反馈

- 颜色编码帮助快速识别状态
- 图标提供直观的视觉提示
- Tooltip提供详细信息

### 4. 响应式设计

- 在移动端也能正常显示
- 保持良好的可读性
- 适配不同屏幕尺寸

## 相关文档

- [使用指南](./USAGE.md) - 应用使用说明
- [更新日志](./CHANGELOG.md) - v1.5.1版本更新
- [数据抓取指南](./SCRAPING_GUIDE.md) - 数据抓取实现

## 版本信息

- **版本**：v1.5.1
- **发布日期**：2026-01-26
- **功能状态**：✅ 已完成并测试通过
