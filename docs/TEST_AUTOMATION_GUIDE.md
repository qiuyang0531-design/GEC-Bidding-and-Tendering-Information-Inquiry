# 自动化抓取功能测试指南

本文档提供完整的测试步骤，用于验证自动化抓取功能是否正常工作。

## 📋 前置条件

在开始测试之前，请确保已完成以下步骤：

1. ✅ 执行数据库迁移（`setup-automation.sql`）
2. ✅ 部署 Edge Functions（`scrape-automated`, `send-notification`）
3. ✅ 使用管理员账号登录

---

## 🧪 测试流程

### 阶段 1：数据库验证

**步骤：**
1. 登录 Supabase 仪表板
2. 进入 "Table Editor"
3. 验证以下表已创建：
   - ✅ `scraping_configs`
   - ✅ `scraping_logs`
   - ✅ `notifications`
   - ✅ `data_sources`
4. 验证 `urls` 表新增了以下字段：
   - ✅ `is_auto_scrape`
   - ✅ `scrape_interval_hours`
   - ✅ `last_scraped_at`

**预期结果：** 所有表和字段都存在

---

### 阶段 2：UI 组件验证

**步骤：**
1. 启动应用（如果还未启动）
2. 使用管理员账号登录
3. 访问首页
4. 检查左侧边栏是否显示：
   - ✅ 网址管理（已有）
   - ✅ 数据源管理（新增）
   - ✅ 抓取历史（新增）

**预期结果：** 管理员可以看到所有三个组件

**非管理员登录：**
- ❌ 不应看到"数据源管理"和"抓取历史"

---

### 阶段 3：数据源管理测试

**步骤：**
1. 点击"添加数据源"按钮
2. 填写表单：
   - **数据源名称：** 测试数据源
   - **基础URL：** https://example.com
   - **解析器配置：** 使用默认配置
3. 点击"保存"
4. 验证数据源出现在列表中
5. 测试编辑功能
6. 测试禁用/启用开关
7. 测试删除功能

**预期结果：**
- ✅ 数据源成功添加
- ✅ 编辑功能正常
- ✅ 状态切换正常
- ✅ 删除功能正常

---

### 阶段 4：Edge Functions 测试

#### 测试 4.1：手动触发抓取

**步骤：**
1. 在浏览器中打开开发者工具（F12）
2. 切换到 Console 标签
3. 执行以下代码：

```javascript
// 获取用户的 URL
const { data: urls } = await supabase
  .from('urls')
  .select('*')
  .limit(1);

if (urls && urls.length > 0) {
  // 触发抓取
  const { data, error } = await supabase.functions.invoke('scrape-automated', {
    body: { urlId: urls[0].id }
  });

  console.log('抓取结果:', data);
  console.log('错误:', error);
}
```

**预期结果：**
- ✅ 返回抓取结果
- ✅ `scraping_logs` 表中新增记录

---

#### 测试 4.2：发送通知测试

**步骤：**
在 Console 中执行：

```javascript
// 获取当前用户ID
const { data: { user } } = await supabase.auth.getUser();

// 创建测试通知
const { data, error } = await supabase.functions.invoke('send-notification', {
  body: {
    userId: user.id,
    type: 'scraping_success',
    title: '测试通知',
    message: '这是一条测试通知',
    sendEmail: false
  }
});

console.log('通知结果:', data);
console.log('错误:', error);
```

**预期结果：**
- ✅ 通知创建成功
- ✅ `notifications` 表中新增记录
- ✅ 右上角通知图标显示未读数量

---

### 阶段 5：通知功能测试

**步骤：**
1. 点击右上角的通知图标（铃铛）
2. 验证通知下拉列表显示
3. 点击一条通知
4. 验证通知标记为已读
5. 点击"全部已读"按钮
6. 验证所有通知都已读
7. 点击"×"删除一条通知
8. 访问 `/notifications` 页面
9. 验证完整的通知中心显示

**预期结果：**
- ✅ 通知下拉列表正常显示
- ✅ 点击通知标记为已读
- ✅ 全部已读功能正常
- ✅ 删除功能正常
- ✅ 通知中心页面正常显示

---

### 阶段 6：抓取历史测试

**步骤：**
1. 在首页找到"抓取历史"卡片
2. 验证历史记录显示（如果有）
3. 测试状态筛选按钮：
   - 点击"成功"
   - 点击"失败"
   - 点击"部分"
   - 点击"全部"

**预期结果：**
- ✅ 抓取历史正确显示
- ✅ 状态筛选功能正常
- ✅ 统计信息正确（总记录、新增、更新、重复）

---

### 阶段 7：端到端集成测试

**完整流程：**
1. 添加一个新的数据源（使用真实的可抓取URL）
2. 添加对应的URL到网址管理
3. 手动触发一次抓取
4. 验证：
   - ✅ 抓取成功
   - ✅ 数据保存到 transactions 表
   - ✅ 抓取日志记录到 scraping_logs 表
   - ✅ 通知创建成功
5. 检查"抓取历史"是否显示最新记录
6. 检查通知是否收到

**预期结果：** 整个流程顺畅，所有功能正常工作

---

## 🐛 常见问题排查

### 问题 1：组件不显示

**可能原因：**
- 数据库迁移未执行
- RLS 策略配置错误
- 用户不是管理员

**解决方案：**
1. 检查数据库表是否存在
2. 检查用户角色：`SELECT * FROM profiles WHERE id = auth.uid()`
3. 确认是否使用管理员账号登录

---

### 问题 2：Edge Function 调用失败

**可能原因：**
- Function 未部署
- Function 名称错误
- 权限问题

**解决方案：**
1. 在 Supabase 仪表板检查 Function 是否存在
2. 查看 Function 日志
3. 确认 RLS 策略允许写入

---

### 问题 3：抓取失败

**可能原因：**
- 目标网站不可访问
- HTML 结构变化
- 解析器配置错误

**解决方案：**
1. 检查目标URL是否可访问
2. 查看抓取日志中的 `error_details`
3. 调整解析器配置

---

### 问题 4：通知不显示

**可能原因：**
- 通知未创建
- 通知创建失败
- 读取权限问题

**解决方案：**
1. 检查 `notifications` 表
2. 查看 Console 错误信息
3. 确认 RLS 策略允许读取

---

## ✅ 测试清单

使用此清单确保所有功能都已测试：

### 数据库
- [ ] scraping_configs 表存在
- [ ] scraping_logs 表存在
- [ ] notifications 表存在
- [ ] data_sources 表存在
- [ ] urls 表字段已扩展

### UI 组件
- [ ] 数据源管理显示（管理员）
- [ ] 抓取历史显示（管理员）
- [ ] 通知中心显示（所有用户）

### 功能测试
- [ ] 添加数据源
- [ ] 编辑数据源
- [ ] 启用/禁用数据源
- [ ] 删除数据源
- [ ] 手动触发抓取
- [ ] 创建通知
- [ ] 标记通知已读
- [ ] 全部已读
- [ ] 删除通知
- [ ] 查看抓取历史
- [ ] 状态筛选

### Edge Functions
- [ ] scrape-automated 部署
- [ ] send-notification 部署
- [ ] Function 调用成功

---

## 📊 测试报告模板

**测试日期：** ___________
**测试人员：** ___________
**环境：** □ 开发 □ 测试 □ 生产

### 测试结果
- 通过：_____
- 失败：_____
- 阻塞：_____

### 发现的问题
1.
2.
3.

### 总体评估
□ 通过所有测试
□ 部分功能需要修复
□ 需要重新测试

---

## 🎯 下一步

测试完成后：
1. 修复发现的问题
2. 完善文档
3. 准备生产环境部署
4. 设置定时任务（如需要）
